# GNN Vulnerability Detection

> Graph Neural Networks for Code Vulnerability Mining - Research & Implementation

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Python](https://img.shields.io/badge/python-3.9+-green.svg)](https://python.org)
[![PyTorch](https://img.shields.io/badge/pytorch-2.0+-orange.svg)](https://pytorch.org)

## Overview

This repository contains research materials and implementation for GNN-based vulnerability detection, based on a systematic review of **55 top-tier papers** and hands-on testing of **7 open-source projects**.

### Key Findings

| Metric | GAT (GNN) | CodeBERT | GPT-4 (zero-shot) |
|--------|-----------|----------|-------------------|
| F1 Score | 0.62 | 0.65 | 0.55 |
| Inference | 1,200 func/sec | 200 func/sec | 5 func/sec |
| Training Cost | 2hr/A100 | 8hr/A100 | $0.01/func |

**Bottom line**: GNN is 20x faster than LLM with comparable accuracy. Best for CI/CD integration.

## Quick Start

### Installation

```bash
# Clone repository
git clone https://github.com/sgInnora/gnn-vuln-detection.git
cd gnn-vuln-detection

# Install dependencies
pip install -r requirements.txt

# Install Joern for CPG generation
brew install joern  # macOS
# or see https://joern.io for other platforms
```

### Generate CPG

```bash
# Parse C/C++ code
joern-parse /path/to/code --language c --output code.cpg

# Export to DOT format (optional, for visualization)
joern-export code.cpg --repr cpg14 --format dot
```

### Train Model

```python
from models import VulnDetector
from torch_geometric.data import DataLoader

# Load preprocessed graph data
train_loader = DataLoader(train_dataset, batch_size=32)

# Initialize model
model = VulnDetector(in_dim=128, hidden_dim=256, heads=8)

# Train
for epoch in range(100):
    for batch in train_loader:
        optimizer.zero_grad()
        out = model(batch.x, batch.edge_index, batch.batch)
        loss = focal_loss(out, batch.y)
        loss.backward()
        optimizer.step()
```

### Evaluate

```bash
python evaluate.py --model checkpoints/best.pt --dataset big-vul
```

## Model Architecture

```
                    ┌─────────────────┐
                    │   Input Graph   │
                    │  (CPG: AST+CFG+ │
                    │      PDG)       │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Node Embedding │
                    │   (CodeBERT)    │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
     ┌────────▼────────┐     │     ┌────────▼────────┐
     │   GAT Layer 1   │     │     │   GAT Layer 2   │
     │  (8 heads, 256) │─────┼────▶│  (1 head, 256)  │
     └─────────────────┘     │     └────────┬────────┘
                             │              │
                    ┌────────▼────────┐     │
                    │  Global Pooling │◀────┘
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   Classifier    │
                    │  (Vulnerable?)  │
                    └─────────────────┘
```

## Datasets

| Dataset | Functions | Source | Realism |
|---------|-----------|--------|---------|
| **Big-Vul** | 188K | GitHub commits | ⭐⭐⭐⭐ |
| **DiverseVul** | 150+ CWEs | Multi-source | ⭐⭐⭐⭐⭐ |
| **Draper** | 1.27M | Static analyzer | ⭐⭐⭐ |
| SARD | Synthetic | NIST | ⭐⭐ (avoid) |

> ⚠️ **Warning**: Don't benchmark on SARD. Synthetic patterns don't generalize.

### Data Preprocessing

```bash
# Download Big-Vul
python scripts/download_bigvul.py

# Generate CPGs (takes ~2 hours)
python scripts/generate_cpg.py --input data/bigvul --output data/cpg

# Graph slicing (recommended)
python scripts/slice_graphs.py --sinks strcpy,memcpy,system
```

## When to Use GNN vs LLM

| Scenario | Recommendation | Why |
|----------|----------------|-----|
| CI/CD daily scan | **GNN** | 20x faster inference |
| Audit compliance | **GNN** | Attention weights explainable |
| Novel vulnerability | **LLM** | Better zero-shot generalization |
| Need fix suggestions | **LLM** | Can generate patches |
| Maximum accuracy | **Hybrid** | Best of both worlds |

## Common Issues

### Graph Too Large

**Problem**: Out of memory on large CPGs

**Solution**: Use backward slicing from sensitive sinks

```python
# Joern query for slicing
sinks = cpg.call.name("strcpy").l
slice = sinks.flatMap(sink => sink.reachableByFlows(cpg.method.parameter, 5))
```

### Class Imbalance

**Problem**: Model predicts everything as "safe"

**Solution**: Focal Loss + threshold adjustment

```python
class FocalLoss(nn.Module):
    def __init__(self, gamma=2.0, alpha=0.75):
        super().__init__()
        self.gamma = gamma
        self.alpha = alpha
```

### Over-smoothing

**Problem**: Training loss drops but accuracy doesn't improve

**Solution**: Limit GNN layers to 4-6, add residual connections

## Paper References

### Essential Reading (Top 5)

1. **DEVIGN** (NeurIPS 2019) - Foundational GNN vulnerability detection
2. **DeepWukong** (TOSEM 2021) - Graph slicing methodology
3. **LineVul** (MSR 2022) - Transformer baseline
4. **Vul-LMGNNs** (2023) - LLM+GNN hybrid
5. **HAGNN** (arXiv 2025) - Heterogeneous attention GNN, SOTA

### 2024-2025 Highlights

- **CFExplainer** (ISSTA 2024) - Counterfactual explanation for vulnerability root cause
- **VulGCANet** (TrustCom 2024) - GCN+GAT hybrid for cross-function tracking
- **Google Big Sleep** (2025) - First AI to discover real SQLite 0-day (CVE-2025-6965)

### Full Paper List

See [papers/README.md](papers/README.md) for complete list of 55 papers with BibTeX.

## Project Structure

```
gnn-vuln-detection/
├── models/
│   ├── gat.py           # GAT implementation
│   ├── ggnn.py          # Gated GNN
│   └── focal_loss.py    # Class imbalance handling
├── data/
│   ├── bigvul/          # Big-Vul dataset
│   └── cpg/             # Generated CPGs
├── scripts/
│   ├── generate_cpg.py  # Joern CPG generation
│   ├── slice_graphs.py  # Graph slicing
│   └── evaluate.py      # Model evaluation
├── papers/
│   └── README.md        # 55 papers with BibTeX
└── notebooks/
    └── analysis.ipynb   # Result visualization
```

## Contributing

Contributions welcome! Please read [CONTRIBUTING.md](CONTRIBUTING.md) first.

Areas where help is needed:
- [ ] Support for more languages (Go, Rust)
- [ ] Improved graph slicing heuristics
- [ ] Hybrid GNN+LLM implementation

## Citation

If you use this work, please cite:

```bibtex
@misc{feng2026gnnvuln,
  author = {Feng, Jiqiang},
  title = {GNN Vulnerability Detection: Research and Implementation},
  year = {2026},
  publisher = {GitHub},
  url = {https://github.com/sgInnora/gnn-vuln-detection}
}
```

## License

MIT License - see [LICENSE](LICENSE) for details.

## Contact

- **Author**: Jiqiang Feng (风宁)
- **Email**: feng@innora.ai
- **GitHub**: [@sgInnora](https://github.com/sgInnora)

---

*Built with ❤️ for the security research community*
